<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MGMH Paris — Calculatrice Amazon (FBM/FBA)</title>
  <meta name="theme-color" content="#0b0f1c">
  <link rel="manifest" href="manifest.webmanifest?v=2">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MGMH Calc">
  <style>
    :root{
      --bg:#0b0f1c;--card:#0e1426;--line:#1f2a44;--text:#e6e8ee;--muted:#9aa3b2;
      --accent:#2563eb;--brand:#d4af37;--pill:#111827;--radius:14px;
      --safe-bottom:env(safe-area-inset-bottom,12px)
    }
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 85% -10%, rgba(212,175,55,.08), transparent 50%),var(--bg);
      color:var(--text);font-family:ui-sans-serif,-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .hero{position:sticky;top:0;z-index:5;padding:clamp(16px,3.6vw,28px) clamp(14px,4.5vw,28px);
      border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0a0f1e,#0b0f1c 60%)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg, rgba(212,175,55,.18), rgba(212,175,55,.05));
      border:1px solid rgba(212,175,55,.35);display:grid;place-items:center;font-weight:800;letter-spacing:2px;color:var(--brand)}
    .brand h1{margin:0;font-size:clamp(18px,4vw,26px);display:flex;gap:10px;align-items:baseline}
    .sub{font-size:.9rem;color:var(--muted);font-weight:600;letter-spacing:.3px}
    .hero-actions{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .lang{padding:8px 10px;border-radius:10px;background:#0d1325;border:1px solid var(--line);color:#cbd5e1;font-weight:600}
    .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    .tab{padding:10px 8px;border-radius:10px;background:#0d1325;border:1px solid var(--line);text-align:center;color:#cbd5e1;font-weight:600;font-size:.95rem}
    .tab.active{background:#121a33;border-color:#32406a}
    main{max-width:1100px;margin:0 auto;padding:12px clamp(14px,4.5vw,28px) 100px;display:grid;gap:14px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:clamp(12px,2.4vw,18px)}
    h2{margin:0 0 8px 0;font-size:1.05rem}
    .grid{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 170px;gap:10px;align-items:center}
    @media (max-width:740px){.row{grid-template-columns:1fr}}
    label{color:#cbd5e1;font-size:.95rem}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #2a3553;background:#0a0f1e;color:var(--text);outline:none}
    input:focus,select:focus{border-color:#3e4a6f;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .muted{color:var(--muted);font-size:.92rem}
    .kpi{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px 12px;border:1px dashed #2a3553;border-radius:10px;background:#0a1022}
    .kpi .value{font-weight:800}
    .hidden{display:none}
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:9px 10px;border-bottom:1px solid #17203a;font-size:.95rem}
    th{text-align:left;color:#cbd5e1;font-weight:600} td{text-align:right}
    td:first-child,th:first-child{position:sticky;left:0;background:var(--card);text-align:left}
    .bar{position:fixed;left:0;right:0;bottom:0;z-index:10;background:rgba(11,15,28,.9);backdrop-filter:blur(6px);
      border-top:1px solid var(--line);padding:10px 12px calc(var(--safe-bottom));display:flex;gap:8px;justify-content:space-between}
    .bar button{flex:1} button{background:var(--accent);color:white;border:none;padding:12px;border-radius:12px;font-weight:800}
    button.secondary{background:#0b132a;border:1px solid #2a3553;color:#e5e7eb}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#111827;border:1px solid var(--line);color:#cbd5e1;font-size:.85rem}
    .panel{display:none}.panel.active{display:block}
    canvas{width:100%;height:220px;max-height:260px;display:block}
    .footer{color:#9aa3b2;text-align:center;font-size:.85rem;margin-top:6px}
  </style>
</head>
<body>
  <header class="hero">
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <h1>MGMH Paris <span class="sub" data-i18n="subtitle">Calculatrice Amazon (FBM/FBA)</span></h1>
        <div class="hero-actions">
          <div class="pill">AE (sans TVA)</div>
          <button id="langToggle" class="lang">FR 🇫🇷</button>
        </div>
      </div>
    </div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-panel="inputs" data-i18n="tab_inputs">Entrées</div>
      <div class="tab" data-panel="results" data-i18n="tab_results">Résultats</div>
      <div class="tab" data-panel="macro" data-i18n="tab_macro">Macro</div>
      <div class="tab" data-panel="compare" data-i18n="tab_compare">Comparateur</div>
    </div>
  </header>

  <main>
    <!-- 1) ENTRÉES -->
    <section id="panel-inputs" class="panel active">
      <h2 data-i18n="inputs_title">Entrées (produit)</h2>
      <div class="grid">

        <div class="row"><label data-i18n="asin">ASIN (optionnel)</label>
          <div style="display:flex;gap:8px">
            <input id="asin" placeholder="ex. B0CXXXXXXX" style="flex:1" autocapitalize="characters" />
            <button class="secondary" id="btnFetch" data-i18n="fetch">Récupérer</button>
          </div>
        </div>

        <div class="row"><label data-i18n="name">Nom du produit</label><input id="p_name" placeholder="ex. Brume 90 ml"></div>

        <div class="row"><label data-i18n="mode">Mode</label>
          <select id="mode">
            <option value="FBM">FBM — Expédition par moi</option>
            <option value="FBA">FBA — Fulfillment by Amazon</option>
          </select>
        </div>

        <div class="row"><label data-i18n="plan">Plan Amazon</label>
          <select id="amzPlan">
            <option value="individual">Individuel — 0,99 € / vente</option>
            <option value="pro">Pro — 0 € / vente (abonnement)</option>
          </select>
        </div>

        <div class="row"><label data-i18n="category">Catégorie (commission)</label>
          <select id="amzCategory"></select>
        </div>

        <div class="row"><label data-i18n="amzRate">Commission Amazon %</label><input id="amazonRate" inputmode="decimal" value="0"></div>
        <div class="row"><label data-i18n="amzFixed">Frais fixes Amazon €</label><input id="amazonFixed" inputmode="decimal" value="0"></div>

        <div class="row"><label data-i18n="price">Prix de vente TTC €</label><input id="price" inputmode="decimal" value="0"></div>
        <div class="row"><label data-i18n="cogs">Coût d’achat €</label><input id="cogs" inputmode="decimal" value="0"></div>
        <div class="row"><label data-i18n="pack">Emballage €</label><input id="pack" inputmode="decimal" value="0"></div>

        <!-- FBM -->
        <div id="fbmBlock">
          <div class="row"><label data-i18n="shipProfile">Profil transporteur (FBM)</label>
            <select id="shipProfile">
              <option value="">— Choisir (optionnel)</option>
              <option value="4.50" selected>Par défaut (léger / relais) ~ 4,50 €</option>
              <option value="4.40">Mondial Relay (≤500 g) ~ 4,40 €</option>
              <option value="6.99">Colissimo Relais ~ 6,99 €</option>
              <option value="8.10">Colissimo Domicile ~ 8,10 €</option>
              <option value="4.25">Shop2Shop (Chrono Relais) ~ 4,25 €</option>
            </select>
          </div>
          <div class="row"><label data-i18n="ship">Expédition client (FBM) €</label><input id="ship" inputmode="decimal" value="4,50"></div>
        </div>

        <!-- FBA -->
        <div id="fbaBlock" class="hidden">
          <div class="row"><label data-i18n="fbaTier">Palier FBA</label><select id="fbaTier"></select></div>
          <div class="row"><label data-i18n="fbaFee">Frais traitement FBA €/u</label><input id="fbaFee" inputmode="decimal" value="0"></div>
          <div class="row"><label data-i18n="fbaInbound">Expédition vers Amazon €/u</label><input id="fbaInbound" inputmode="decimal" value="0"></div>
          <div class="row"><label data-i18n="fbaStorage">Stockage €/u (optionnel)</label><input id="fbaStorage" inputmode="decimal" value="0"></div>
          <div class="row"><label data-i18n="weight">Poids (kg)</label><input id="weight" inputmode="decimal" value="0.35"></div>
          <div class="row"><label data-i18n="dims">Dimensions (L×l×H cm)</label>
            <div style="display:flex;gap:6px">
              <input id="dimL" inputmode="decimal" placeholder="L" value="18">
              <input id="dimW" inputmode="decimal" placeholder="l" value="8">
              <input id="dimH" inputmode="decimal" placeholder="H" value="8">
            </div>
          </div>
          <div class="row"><label></label><button class="secondary" id="btnFbaAuto" data-i18n="estimateFba">Estimer frais FBA (auto)</button></div>
        </div>

        <div class="row"><label data-i18n="urssaf">URSSAF % (base CA TTC)</label><input id="urssafRate" inputmode="decimal" value="12,5"></div>
        <div class="row"><label data-i18n="other">Autres coûts / u €</label><input id="other" inputmode="decimal" value="0"></div>

        <!-- Scénarios -->
        <div class="row"><label data-i18n="scenarioName">Nom du scénario</label>
          <div style="display:flex;gap:8px">
            <input id="scenarioName" placeholder="ex. Brume 90 ml FBM">
            <button class="secondary" id="btnSave" data-i18n="save">Sauver</button>
          </div>
        </div>
        <div class="row"><label data-i18n="loadScenario">Charger scénario</label>
          <div style="display:flex;gap:8px">
            <select id="scenarioList"></select>
            <button class="secondary" id="btnLoad" data-i18n="load">Charger</button>
            <button class="secondary" id="btnDelete" data-i18n="delete">Supprimer</button>
          </div>
        </div>

        <p class="muted" data-i18n="hint">AE : pas de TVA. Commission Amazon = (% catégorie × prix) + frais fixes (0,99 € si plan Individuel). Tu peux tout modifier.</p>
      </div>
    </section>

    <!-- 2) RÉSULTATS -->
    <section id="panel-results" class="panel">
      <h2 data-i18n="results_title">Résultats</h2>
      <div class="grid">
        <div class="kpi"><span data-i18n="k_amz">Commission Amazon</span><span class="value" id="v_amzFee">—</span></div>
        <div class="kpi"><span data-i18n="k_cost">Coûts totaux</span><span class="value" id="v_totalCost">—</span></div>
        <div class="kpi"><span data-i18n="k_gross">Marge brute</span><span class="value" id="v_gross">—</span></div>
        <div class="kpi"><span data-i18n="k_urssaf">URSSAF</span><span class="value" id="v_urssaf">—</span></div>
        <div class="kpi"><span data-i18n="k_net">Marge nette</span><span class="value" id="v_net">—</span></div>
        <div class="kpi"><span data-i18n="k_netpct">Marge nette (%)</span><span class="value" id="v_netPct">—</span></div>
        <div class="kpi"><span data-i18n="k_roi">ROI coût d’achat</span><span class="value" id="v_roi">—</span></div>
        <div class="kpi"><span data-i18n="k_be">Prix plancher</span><span class="value" id="v_breakeven">—</span></div>
        <div class="kpi"><span data-i18n="k_reco">Recommandation</span><span class="value" id="v_callout">—</span></div>
      </div>

      <h2 style="margin-top:14px" data-i18n="chart_title">Prix ↔ Marge nette (simulation)</h2>
      <canvas id="chart"></canvas>
      <div class="row">
        <label data-i18n="chart_range">Plage de prix</label>
        <div style="display:flex;gap:8px">
          <input id="priceMin" inputmode="decimal" value="10">
          <input id="priceMax" inputmode="decimal" value="40">
          <button class="secondary" id="btnChart" data-i18n="redraw">Redessiner</button>
        </div>
      </div>
    </section>

    <!-- 3) MACRO -->
    <section id="panel-macro" class="panel">
      <h2 data-i18n="macro_title">Analyse macro (lots)</h2>
      <div class="grid">
        <div class="row">
          <label data-i18n="quantities">Quantités (séparées par des virgules)</label>
          <input id="qtyList" inputmode="numeric" value="10,50,100,250,500">
        </div>
        <div class="table-wrap">
          <table id="macroTable">
            <thead>
              <tr>
                <th data-i18n="qty">Quantité</th><th data-i18n="rev">CA total</th><th data-i18n="tcost">Coût total</th>
                <th>URSSAF</th><th data-i18n="tnet">Net total</th><th data-i18n="netu">Net / pièce</th>
                <th data-i18n="netpct">Net (%)</th><th data-i18n="roiglobal">ROI global</th>
              </tr>
            </thead><tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 4) COMPARATEUR -->
    <section id="panel-compare" class="panel">
      <h2 data-i18n="compare_title">Comparateur multi-produits</h2>
      <div class="grid">
        <div class="row">
          <label data-i18n="importCsv">Importer CSV</label>
          <input id="csvFile" type="file" accept=".csv">
        </div>
        <div class="row">
          <label data-i18n="exports">Exports</label>
          <div style="display:flex;gap:8px">
            <button class="secondary" id="btnExportCSV">CSV</button>
            <button class="secondary" id="btnExportXLS">Excel (.xls)</button>
          </div>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:8px">
        <table id="compTable">
          <thead>
            <tr>
              <th data-i18n="p">Produit</th><th data-i18n="m">Mode</th><th data-i18n="pr">Prix</th><th data-i18n="co">Achat</th>
              <th data-i18n="pk">Emb.</th><th data-i18n="exin">Expé/Inbound</th><th data-i18n="fba">Trait. FBA</th>
              <th data-i18n="camz">Comm. Amz</th><th>URSSAF</th><th data-i18n="ct">Coût total</th>
              <th data-i18n="n">Net €</th><th data-i18n="np">Net %</th><th data-i18n="r">ROI %</th>
              <th data-i18n="be">Prix plancher</th><th data-i18n="rec">Reco</th><th data-i18n="act">Action</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
      <p class="footer">M G M H &nbsp; P A R I S — v1.5 — SW v4</p>
    </section>
  </main>

  <!-- Barre d’actions -->
  <div class="bar">
    <button id="btnCalc" data-i18n="calc">Calculer</button>
    <button class="secondary" id="btnPreset" data-i18n="preset">Preset</button>
    <button class="secondary" id="btnAddRow" data-i18n="addToComp">+ Comparateur</button>
    <button class="secondary" id="btnExport" data-i18n="exportComp">CSV Comp.</button>
  </div>

  <!-- Base JSON intégrée -->
  <script type="application/json" id="fee-db">
  {
    "categories":[
      {"label":"Beauté / Hygiène / Parfum","rate":15},
      {"label":"Maison / Cuisine","rate":15},
      {"label":"Sports / Loisirs","rate":15},
      {"label":"Électronique (moy.)","rate":12},
      {"label":"Informatique (certains articles)","rate":8},
      {"label":"Autres (par défaut)","rate":15}
    ],
    "fba_tiers":[
      {"label":"Petit standard ≤150g","fee":2.80},
      {"label":"Standard 150–400g","fee":3.10},
      {"label":"Standard 400–950g","fee":3.80},
      {"label":"Grand standard 0.95–1.9kg","fee":5.10},
      {"label":"Surdimensionné léger","fee":6.50}
    ]
  }
  </script>

  <script>
    // ===== CONFIG ASIN (optionnel) =====
    const AMZ_ENDPOINT = ""; // renseigne plus tard (Netlify/Vercel). Laisse vide pour mode démo.

    // ===== i18n =====
    const I18N = {
      fr: {
        subtitle:"Calculatrice Amazon (FBM/FBA)", tab_inputs:"Entrées", tab_results:"Résultats", tab_macro:"Macro", tab_compare:"Comparateur",
        inputs_title:"Entrées (produit)", asin:"ASIN (optionnel)", fetch:"Récupérer", name:"Nom du produit", mode:"Mode",
        plan:"Plan Amazon", category:"Catégorie (commission)", amzRate:"Commission Amazon %", amzFixed:"Frais fixes Amazon €",
        price:"Prix de vente TTC €", cogs:"Coût d’achat €", pack:"Emballage €", shipProfile:"Profil transporteur (FBM)",
        ship:"Expédition client (FBM) €", fbaTier:"Palier FBA", fbaFee:"Frais traitement FBA €/u", fbaInbound:"Expédition vers Amazon €/u",
        fbaStorage:"Stockage €/u (optionnel)", weight:"Poids (kg)", dims:"Dimensions (L×l×H cm)", estimateFba:"Estimer frais FBA (auto)",
        urssaf:"URSSAF % (base CA TTC)", other:"Autres coûts / u €", scenarioName:"Nom du scénario", save:"Sauver",
        loadScenario:"Charger scénario", load:"Charger", delete:"Supprimer",
        hint:"AE : pas de TVA. Commission Amazon = (% catégorie × prix) + frais fixes (0,99 € si plan Individuel). Tu peux tout modifier.",
        results_title:"Résultats", k_amz:"Commission Amazon", k_cost:"Coûts totaux", k_gross:"Marge brute", k_urssaf:"URSSAF",
        k_net:"Marge nette", k_netpct:"Marge nette (%)", k_roi:"ROI coût d’achat", k_be:"Prix plancher", k_reco:"Recommandation",
        chart_title:"Prix ↔ Marge nette (simulation)", chart_range:"Plage de prix", redraw:"Redessiner",
        macro_title:"Analyse macro (lots)", quantities:"Quantités (séparées par des virgules)",
        qty:"Quantité", rev:"CA total", tcost:"Coût total", tnet:"Net total", netu:"Net / pièce", netpct:"Net (%)", roiglobal:"ROI global",
        compare_title:"Comparateur multi-produits", importCsv:"Importer CSV", exports:"Exports",
        p:"Produit", m:"Mode", pr:"Prix", co:"Achat", pk:"Emb.", exin:"Expé/Inbound", fba:"Trait. FBA", camz:"Comm. Amz", ct:"Coût total",
        n:"Net €", np:"Net %", r:"ROI %", be:"Prix plancher", rec:"Reco", act:"Action",
        calc:"Calculer", preset:"Preset", addToComp:"+ Comparateur", exportComp:"CSV Comp."
      },
      en: {
        subtitle:"Amazon Calculator (FBM/FBA)", tab_inputs:"Inputs", tab_results:"Results", tab_macro:"Macro", tab_compare:"Compare",
        inputs_title:"Inputs (product)", asin:"ASIN (optional)", fetch:"Fetch", name:"Product name", mode:"Mode",
        plan:"Amazon plan", category:"Category (commission)", amzRate:"Amazon fee %", amzFixed:"Amazon fixed fee €",
        price:"Sale price (incl. VAT) €", cogs:"Cost of goods €", pack:"Packaging €", shipProfile:"Carrier profile (FBM)",
        ship:"Customer shipping (FBM) €", fbaTier:"FBA tier", fbaFee:"FBA handling €/u", fbaInbound:"Inbound to Amazon €/u",
        fbaStorage:"Storage €/u (opt.)", weight:"Weight (kg)", dims:"Dimensions (L×W×H cm)", estimateFba:"Estimate FBA (auto)",
        urssaf:"URSSAF % (on gross sales)", other:"Other costs / u €", scenarioName:"Scenario name", save:"Save",
        loadScenario:"Load scenario", load:"Load", delete:"Delete",
        hint:"Sole trader: no VAT. Amazon commission = (category % × price) + fixed fee (€0.99 if Individual plan). You can edit anything.",
        results_title:"Results", k_amz:"Amazon commission", k_cost:"Total costs", k_gross:"Gross margin", k_urssaf:"URSSAF",
        k_net:"Net margin", k_netpct:"Net margin (%)", k_roi:"ROI on COGS", k_be:"Breakeven price", k_reco:"Suggestion",
        chart_title:"Price ↔ Net margin (simulation)", chart_range:"Price range", redraw:"Redraw",
        macro_title:"Macro analysis (lots)", quantities:"Quantities (comma separated)",
        qty:"Quantity", rev:"Total revenue", tcost:"Total cost", tnet:"Total net", netu:"Net / unit", netpct:"Net (%)", roiglobal:"Global ROI",
        compare_title:"Product comparator", importCsv:"Import CSV", exports:"Exports",
        p:"Product", m:"Mode", pr:"Price", co:"COGS", pk:"Pack", exin:"Ship/Inbound", fba:"FBA handling", camz:"Amz comm.", ct:"Total cost",
        n:"Net €", np:"Net %", r:"ROI %", be:"Breakeven", rec:"Hint", act:"Action",
        calc:"Compute", preset:"Preset", addToComp:"+ Compare", exportComp:"CSV Comp."
      }
    };
    let LANG='fr';
    function applyI18n(){
      const dict=I18N[LANG];
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.getAttribute('data-i18n'); if(dict[k]) el.textContent=dict[k];
      });
      document.getElementById('langToggle').textContent = LANG==='fr' ? 'FR 🇫🇷' : 'EN 🇬🇧';
      document.documentElement.lang = LANG;
    }

    // ===== Utils =====
    const parseN = v => { v=(v??'').toString().replace(',', '.'); const n=parseFloat(v); return isFinite(n)?n:0; };
    const fmtE = n => isFinite(n)? n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' €':'—';
    const fmtP = n => isFinite(n)? n.toLocaleString('fr-FR',{minimumFractionDigits:1,maximumFractionDigits:1})+' %':'—';
    const setTxt=(id,v)=>document.getElementById(id).textContent=v;
    const show=(el,yes)=> el.classList[yes?'remove':'add']('hidden');

    const DB = JSON.parse(document.getElementById('fee-db').textContent);

    // ===== Tabs =====
    const tabs=document.querySelectorAll('.tab');
    const panels={inputs:panel('inputs'),results:panel('results'),macro:panel('macro'),compare:panel('compare')};
    function panel(name){return document.getElementById('panel-'+name)}
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      Object.values(panels).forEach(p=>p.classList.remove('active'));
      panels[t.dataset.panel].classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    }));

    // ===== Populate selects =====
    const catSelect = document.getElementById('amzCategory');
    const tierSelect = document.getElementById('fbaTier');
    catSelect.innerHTML = '<option value="">— Sélectionne une catégorie</option>' +
      DB.categories.map(c=>`<option value="${c.rate}">${c.label} — ${c.rate} %</option>`).join('');
    tierSelect.innerHTML = '<option value="">— Sélectionne un palier</option>' +
      DB.fba_tiers.map(t=>`<option value="${t.fee}">${t.label} — ${t.fee.toFixed(2)} €</option>`).join('');

    // ===== Linking fields =====
    byId('amzCategory').addEventListener('change', e=>{
      const pct=e.target.value||'0'; byId('amazonRate').value=pct.replace('.', ','); recalc();
    });
    byId('fbaTier').addEventListener('change', e=>{
      const fee=e.target.value||'0'; byId('fbaFee').value=String(fee).replace('.', ','); recalc();
    });
    const planEl = byId('amzPlan');
    planEl.addEventListener('change',()=>{
      byId('amazonFixed').value = (planEl.value==='individual') ? '0,99' : '0'; recalc();
    });
    const modeEl = byId('mode'), fbmBlock=byId('fbmBlock'), fbaBlock=byId('fbaBlock');
    modeEl.addEventListener('change',()=>{const isFBA=modeEl.value==='FBA'; show(fbmBlock,!isFBA?true:false); show(fbaBlock,isFBA?true:false); recalc();});
    byId('shipProfile').addEventListener('change', e=>{const v=e.target.value; if(v) byId('ship').value=String(v).replace('.', ','); recalc();});

    // ===== Inputs / compute =====
    function byId(id){return document.getElementById(id)}
    function inputs(){
      return {
        name: byId('p_name').value.trim()||'Produit',
        mode: byId('mode').value,
        price: parseN(byId('price').value),
        cogs: parseN(byId('cogs').value),
        pack: parseN(byId('pack').value),
        ship: parseN(byId('ship').value),
        amazonRatePct: parseN(byId('amazonRate').value),
        amazonFixed: parseN(byId('amazonFixed').value),
        urssafPct: parseN(byId('urssafRate').value),
        other: parseN(byId('other').value),
        fbaFee: parseN(byId('fbaFee').value),
        fbaInbound: parseN(byId('fbaInbound').value),
        fbaStorage: parseN(byId('fbaStorage').value)
      };
    }
    function computeAE(i){
      const amzFee = i.price*(i.amazonRatePct/100)+i.amazonFixed;
      const logistics = i.mode==='FBM' ? i.ship : (i.fbaInbound+i.fbaStorage);
      const varFBA = i.mode==='FBA' ? i.fbaFee : 0;
      const totalCost = i.cogs+i.pack+logistics+varFBA+amzFee+i.other;
      const gross = i.price-totalCost;
      const urssaf = i.price*(i.urssafPct/100);
      const net = gross-urssaf;
      const netPct = i.price? (net/i.price)*100 : NaN;
      const roi = i.cogs? (net/i.cogs)*100 : NaN;
      return {amzFee,totalCost,gross,urssaf,net,netPct,roi};
    }
    function breakeven(i){
      let lo=0, hi=Math.max(1000,i.price||100);
      for(let k=0;k<40;k++){ const mid=(lo+hi)/2; const o=computeAE({...i,price:mid}); (o.net>0)? hi=mid : lo=mid; }
      return (lo+hi)/2;
    }
    function recalc(){
      const i=inputs(), o=computeAE(i);
      setTxt('v_amzFee',fmtE(o.amzFee)); setTxt('v_totalCost',fmtE(o.totalCost)); setTxt('v_gross',fmtE(o.gross));
      setTxt('v_urssaf',fmtE(o.urssaf)); setTxt('v_net',fmtE(o.net)); setTxt('v_netPct',fmtP(o.netPct)); setTxt('v_roi',fmtP(o.roi));
      setTxt('v_breakeven',fmtE(breakeven(i)));
      setTxt('v_callout', isFinite(o.net)? (o.netPct>=25&&o.roi>=50?'✅ Très bon (go)':o.netPct>=15&&o.roi>=30?'🟨 Correct, à tester':o.net>0?'⚠️ Faible rentabilité':'⛔ Pas rentable'):'—');
      drawChart(); runMacro();
    }

    // ===== FBA auto (poids/dimensions) — heuristique simple
    function estimateFBA(){
      const w=parseN(byId('weight').value); const L=parseN(byId('dimL').value), W=parseN(byId('dimW').value), H=parseN(byId('dimH').value);
      const longest=Math.max(L,W,H); const volume=L*W*H;
      let tierIdx=0; // défaut petit standard
      if(w<=0.15 && longest<=33 && volume<=33*23*2.5) tierIdx=0;
      else if(w<=0.40 && longest<=35) tierIdx=1;
      else if(w<=0.95 && longest<=45) tierIdx=2;
      else if(w<=1.9) tierIdx=3;
      else tierIdx=4;
      tierSelect.selectedIndex = tierIdx+1; // +1 car option placeholder
      const fee = DB.fba_tiers[tierIdx].fee;
      byId('fbaFee').value = fee.toFixed(2).replace('.', ',');
      recalc();
    }

    // ===== Chart (canvas, sans lib)
    function drawChart(){
      const c=byId('chart'), ctx=c.getContext('2d');
      const Pmin=parseN(byId('priceMin').value)||10, Pmax=parseN(byId('priceMax').value)||40;
      const steps=50, W=c.width=c.clientWidth*2, H=c.height=240*2; ctx.scale(2,2);
      ctx.clearRect(0,0,W,H); ctx.fillStyle='#0a1022'; ctx.fillRect(0,0,W,H);
      // axes
      ctx.strokeStyle='#2a3553'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(40,H/2); ctx.lineTo(W-10,H/2); ctx.stroke();
      // compute points
      const i=inputs(); const xs=[], ys=[];
      let ymin=Infinity, ymax=-Infinity;
      for(let s=0;s<=steps;s++){
        const p=Pmin+(Pmax-Pmin)*s/steps;
        const o=computeAE({...i,price:p});
        xs.push(p); ys.push(o.net); ymin=Math.min(ymin,o.net); ymax=Math.max(ymax,o.net);
      }
      if(!isFinite(ymin)||!isFinite(ymax)){return;}
      if(ymin===ymax){ymin-=1;ymax+=1;}
      const padL=40, padR=18, padT=12, padB=24;
      const X=x=>padL+(x-Pmin)*(W/2-padL-padR)/(Pmax-Pmin);
      const Y=y=> (H/2-padT-padB) - (y-ymin)*(H/2-padT-padB)/(ymax-ymin) + padT;
      // zero line
      if(ymin<0 && ymax>0){ ctx.strokeStyle='#3e4a6f'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(padL,Y(0)); ctx.lineTo(W/2-padR,Y(0)); ctx.stroke(); ctx.setLineDash([]); }
      // line
      ctx.strokeStyle='#6ea8ff'; ctx.lineWidth=2;
      ctx.beginPath();
      for(let k=0;k<xs.length;k++){ const x=X(xs[k]), y=Y(ys[k]); k?ctx.lineTo(x,y):ctx.moveTo(x,y); }
      ctx.stroke();
      // ticks
      ctx.fillStyle='#9aa3b2'; ctx.font='12px system-ui';
      ctx.fillText(fmtE(ymax), W/2-padR-80, Y(ymax)-4);
      ctx.fillText(fmtE(ymin), W/2-padR-80, Y(ymin)+14);
      ctx.fillText(Pmin.toFixed(2)+'€', padL, H/2-6);
      ctx.fillText(Pmax.toFixed(2)+'€', W/2-padR-36, H/2-6);
    }

    // ===== Macro
    function runMacro(){
      const i=inputs(), unit=computeAE(i);
      const list=(byId('qtyList').value||'').split(',').map(s=>parseInt(s.trim(),10)).filter(n=>Number.isFinite(n)&&n>0);
      const tb=byId('macroTable').querySelector('tbody'); tb.innerHTML='';
      list.forEach(q=>{
        const revenue=i.price*q, cost=unit.totalCost*q, urssaf=i.price*(i.urssafPct/100)*q, net=unit.net*q;
        const roiGlobal=i.cogs? (net/(i.cogs*q))*100 : NaN;
        const tr=document.createElement('tr');
        [q,fmtE(revenue),fmtE(cost),fmtE(urssaf),fmtE(net),fmtE(unit.net),fmtP(unit.netPct),fmtP(roiGlobal)]
          .forEach(v=>{const td=document.createElement('td');td.textContent=v;tr.appendChild(td);});
        tb.appendChild(tr);
      });
    }

    // ===== Comparator
    const tbodyComp=byId('compTable').querySelector('tbody');
    function addCurrent(){
      const i=inputs(), o=computeAE(i), p0=breakeven(i);
      const tr=document.createElement('tr');
      const cells=[i.name,i.mode,fmtE(i.price),fmtE(i.cogs),fmtE(i.pack),
        i.mode==='FBM'?fmtE(i.ship):fmtE(i.fbaInbound), i.mode==='FBM'?'—':fmtE(i.fbaFee+i.fbaStorage),
        fmtE(o.amzFee),fmtE(o.urssaf),fmtE(o.totalCost),fmtE(o.net),fmtP(o.netPct),fmtP(o.roi),fmtE(p0),
        (o.netPct>=25&&o.roi>=50)?'✅':(o.netPct>=15&&o.roi>=30)?'🟨':(o.net>0)?'⚠️':'⛔'];
      cells.forEach(c=>{const td=document.createElement('td');td.textContent=c;tr.appendChild(td);});
      const tdAct=document.createElement('td');const del=document.createElement('button');del.textContent='X';del.className='secondary';
      del.onclick=()=>tr.remove(); tdAct.appendChild(del); tr.appendChild(tdAct); tbodyComp.appendChild(tr);
    }
    function exportComparatorCSV(){
      const rows=[], headers=Array.from(byId('compTable').querySelectorAll('thead th')).map(th=>th.textContent.trim());
      rows.push(headers.slice(0,-1));
      tbodyComp.querySelectorAll('tr').forEach(tr=>{
        const tds=Array.from(tr.querySelectorAll('td')).slice(0,-1).map(td=>td.textContent.replace(/\s€|%/g,''));
        rows.push(tds);
      });
      const csv=rows.map(r=>r.map(x=>`"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      download(csv,'text/csv;charset=utf-8;','comparateur_mgmh.csv');
    }
    function exportComparatorXLS(){ // Excel XML 2003 (ouvert par Excel)
      const rows=[]; tbodyComp.querySelectorAll('tr').forEach(tr=>{
        rows.push(Array.from(tr.querySelectorAll('td')).slice(0,-1).map(td=>td.textContent));
      });
      const headers=Array.from(byId('compTable').querySelectorAll('thead th')).slice(0,-1).map(th=>th.textContent);
      const toCell=v=>`<Cell><Data ss:Type="String">${String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;')}</Data></Cell>`;
      const xml=`<?xml version="1.0"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
        xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Worksheet ss:Name="Comparateur">
        <Table>${[headers,...rows].map(r=>`<Row>${r.map(toCell).join('')}</Row>`).join('')}</Table></Worksheet></Workbook>`;
      download(xml,'application/vnd.ms-excel','comparateur_mgmh.xls');
    }

    // ===== CSV Import
    byId('csvFile').addEventListener('change', async (e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      const text=await file.text(); const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
      const hdr=lines.shift().split(',').map(s=>s.trim().toLowerCase());
      // attendu: name,mode,price,cogs,pack,ship,fbaInbound,fbaFee,fbaStorage,amazonRate,amazonFixed,urssafRate,other
      const idx=k=>hdr.indexOf(k);
      lines.forEach(l=>{
        const cols=l.split(',').map(s=>s.replace(/^"|"$/g,'').trim());
        const rec={
          name: cols[idx('name')]||'Produit',
          mode: (cols[idx('mode')]||'FBM').toUpperCase(),
          price: parseN(cols[idx('price')]),
          cogs: parseN(cols[idx('cogs')]),
          pack: parseN(cols[idx('pack')]),
          ship: parseN(cols[idx('ship')]),
          fbaInbound: parseN(cols[idx('fbainbound')]),
          fbaFee: parseN(cols[idx('fbafee')]),
          fbaStorage: parseN(cols[idx('fbastorage')]),
          amazonRatePct: parseN(cols[idx('amazonrate')]),
          amazonFixed: parseN(cols[idx('amazonfixed')]),
          urssafPct: parseN(cols[idx('urssafrate')]),
          other: parseN(cols[idx('other')])
        };
        // calc & append
        const o=computeAE(rec), p0=breakeven(rec);
        const tr=document.createElement('tr');
        const cells=[rec.name,rec.mode,fmtE(rec.price),fmtE(rec.cogs),fmtE(rec.pack),
          rec.mode==='FBM'?fmtE(rec.ship):fmtE(rec.fbaInbound),
          rec.mode==='FBM'?'—':fmtE(rec.fbaFee+rec.fbaStorage),
          fmtE(o.amzFee),fmtE(o.urssaf),fmtE(o.totalCost),fmtE(o.net),fmtP(o.netPct),fmtP(o.roi),fmtE(p0),
          (o.netPct>=25&&o.roi>=50)?'✅':(o.netPct>=15&&o.roi>=30)?'🟨':(o.net>0)?'⚠️':'⛔'];
        cells.forEach(c=>{const td=document.createElement('td');td.textContent=c;tr.appendChild(td);});
        const tdAct=document.createElement('td');const del=document.createElement('button');del.textContent='X';del.className='secondary';
        del.onclick=()=>tr.remove(); tdAct.appendChild(del); tr.appendChild(tdAct); tbodyComp.appendChild(tr);
      });
      e.target.value='';
    });

    // ===== Scénarios (localStorage)
    const KEY='mgmh_scenarios_v1';
    function getScens(){ try{return JSON.parse(localStorage.getItem(KEY)||'[]');}catch{return[]} }
    function setScens(a){ localStorage.setItem(KEY, JSON.stringify(a)); refreshScenarioList(); }
    function currentScenario(){
      const i=inputs(); return {ts:Date.now(), name:byId('scenarioName').value.trim()||i.name, data:i};
    }
    function loadScenario(obj){
      const d=obj.data;
      byId('p_name').value=d.name; byId('mode').value=d.mode; byId('amzPlan').value=(d.amazonFixed>=0.99?'individual':'pro');
      byId('amazonRate').value=String(d.amazonRatePct).replace('.', ','); byId('amazonFixed').value=String(d.amazonFixed).replace('.', ',');
      byId('price').value=String(d.price).replace('.', ','); byId('cogs').value=String(d.cogs).replace('.', ',');
      byId('pack').value=String(d.pack).replace('.', ','); byId('ship').value=String(d.ship).replace('.', ',');
      byId('fbaFee').value=String(d.fbaFee).replace('.', ','); byId('fbaInbound').value=String(d.fbaInbound).replace('.', ',');
      byId('fbaStorage').value=String(d.fbaStorage).replace('.', ','); byId('urssafRate').value=String(d.urssafPct).replace('.', ',');
      byId('other').value=String(d.other).replace('.', ','); recalc();
    }
    function refreshScenarioList(){
      const list=getScens(); const sel=byId('scenarioList'); sel.innerHTML='';
      list.forEach((s,idx)=>{ const opt=document.createElement('option'); opt.value=idx; opt.textContent=s.name; sel.appendChild(opt); });
    }

    // ===== ASIN (démo)
    async function fetchByASIN(){
      const asin=(byId('asin').value||'').trim(); if(!asin){alert('Entre un ASIN.');return;}
      if(!AMZ_ENDPOINT){
        applyASINData({title:`Produit Amazon (démo ${asin})`, price:24.90, categoryRate:15}, true); return;
      }
      try{
        const r=await fetch(`${AMZ_ENDPOINT}?asin=${encodeURIComponent(asin)}`,{mode:'cors'}); if(!r.ok) throw new Error();
        const d=await r.json(); applyASINData(d,false);
      }catch(e){ alert('Échec de récupération ASIN. Vérifie ton endpoint.'); }
    }
    function applyASINData(d, mock){
      if(d.title) byId('p_name').value=d.title;
      if(Number.isFinite(d.price)) byId('price').value=String(d.price).replace('.', ',');
      if(Number.isFinite(d.categoryRate)){ byId('amazonRate').value=String(d.categoryRate).replace('.', ','); const opt=[...catSelect.options].find(o=>parseN(o.value)===parseN(d.categoryRate)); if(opt) catSelect.value=opt.value; }
      recalc(); if(mock) alert('Mode démo : titre/prix/%cat. remplis. Branche un endpoint pour des données réelles.');
    }

    // ===== Helpers
    function download(content, mime, filename){
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:mime})); a.download=filename;
      document.body.appendChild(a); a.click(); a.remove();
    }

    // ===== Hooks
    document.addEventListener('DOMContentLoaded', ()=>{
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js?v=4').catch(console.error); }
      // i18n
      applyI18n(); byId('langToggle').addEventListener('click',()=>{ LANG = (LANG==='fr'?'en':'fr'); applyI18n(); });
      // actions
      byId('btnCalc').addEventListener('click', recalc);
      byId('btnPreset').addEventListener('click', ()=>{ byId('p_name').value='Brume parfumée 90 ml'; byId('mode').value='FBM';
        byId('amzPlan').value='individual'; byId('amazonRate').value='15'; byId('amazonFixed').value='0,99';
        byId('price').value='24,35'; byId('cogs').value='8,00'; byId('pack').value='0,40'; byId('shipProfile').value='4.50'; byId('ship').value='4,50';
        byId('fbaTier').value=''; byId('fbaFee').value='0'; byId('fbaInbound').value='0'; byId('fbaStorage').value='0'; byId('urssafRate').value='12,5'; byId('other').value='0'; recalc(); });
      byId('btnAddRow').addEventListener('click', addCurrent);
      byId('btnExport').addEventListener('click', exportComparatorCSV);
      byId('btnExportCSV').addEventListener('click', exportComparatorCSV);
      byId('btnExportXLS').addEventListener('click', exportComparatorXLS);
      byId('btnFbaAuto').addEventListener('click', estimateFBA);
      byId('btnChart').addEventListener('click', drawChart);
      byId('btnFetch').addEventListener('click', fetchByASIN);
      ['p_name','mode','amzPlan','amzCategory','price','cogs','pack','ship','amazonRate','amazonFixed','urssafRate','other',
       'fbaTier','fbaFee','fbaInbound','fbaStorage','shipProfile','qtyList','priceMin','priceMax','weight','dimL','dimW','dimH']
        .forEach(id=>byId(id).addEventListener('input', recalc));
      // scénarios
      refreshScenarioList();
      byId('btnSave').addEventListener('click', ()=>{ const s=currentScenario(); const all=getScens(); all.push(s); setScens(all); alert('Scénario sauvegardé.'); });
      byId('btnLoad').addEventListener('click', ()=>{ const idx=parseInt(byId('scenarioList').value,10); const all=getScens(); if(Number.isFinite(idx)&&all[idx]) loadScenario(all[idx]); });
      byId('btnDelete').addEventListener('click', ()=>{ const idx=parseInt(byId('scenarioList').value,10); const all=getScens(); if(Number.isFinite(idx)){ all.splice(idx,1); setScens(all);} });
      // init
      byId('mode').value='FBM'; byId('amzPlan').value='individual'; byId('amazonFixed').value='0,99'; byId('ship').value='4,50'; recalc();
    });
  </script>
</body>
</html>
